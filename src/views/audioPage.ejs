<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Audio Analýza</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<%- include('partials/navbar') %>
<div class="audio-container">
  <p class="description">Nahrávat je doporučeno na mobilním zařízení a zde jen sledovat</p>
  <button id="recordButton" class="record-button">
    <span id="buttonText" class="button-text">START</span>
  </button>
  <p class="description down">Aktuální nahrávání</p>
  <p id="onlyPc" class="not-recording">Přihlašte se přes mobilní zařízení a začněte nahrávat tam</p>
  <p class="unseen">Typ zařízení: <%= deviceTypes %></p>
</div>
<script>
  let stream;
  let recording = false;
  let chunkIndex = 0;

  async function startRecording() {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recording = true;
    chunkIndex = 0;
    loopRecording();
  }

  function loopRecording() {
    if (!recording) return;

    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    mediaRecorder.ondataavailable = e => {
      chunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const currentChunk = chunkIndex++;

      // Spusť odesílání asynchronně, ale nečekej na něj
      sendChunkToServer(blob, currentChunk);
      console.log("blob" + blob)
      console.log("currentChunk" + currentChunk)


      // ✅ mezitím už můžeš rozjet nový rekordér
      loopRecording();
    };

    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 1000);
  }

  async function sendChunkToServer(blob, chunkNumber) {
    const formData = new FormData();
    formData.append("audio_data", blob, `chunk_${chunkNumber}.webm`);

    console.log("Odesílám soubor:", `chunk_${chunkNumber}.webm`); // Přidej log pro kontrolu
    console.log("FormData:", formData);

    try {
      const res = await fetch("/record/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();

      document.getElementById("output").textContent +=
              `Chunk ${chunkNumber}:\n` + JSON.stringify(data, null, 2) + '\n\n';
    } catch (err) {
      console.error("Chyba při uploadu chunku:", err);
    }
  }



  function stopRecording() {
    recording = false;
    if (stream) stream.getTracks().forEach(track => track.stop());
  }

  const recordButton = document.getElementById("recordButton");
  const buttonText = document.getElementById("buttonText");
  const onlyPc = document.getElementById("onlyPc");


  const deviceTypes = "<%= deviceTypes %>";
  if (deviceTypes.includes("mobile") && deviceTypes.includes("desktop")) {
    console.log(onlyPc.style.display);
    onlyPc.style.display = "none";  // Skryje element, pokud je přihlášeno na mobilu i desktopu
  }

  recordButton.addEventListener("click", async () => {

    if(recording) {
      recordButton.classList.remove('active');
      stopRecording()
      recording = false
      buttonText.textContent = "START"
    }
    else {
      recordButton.classList.toggle('active');
      startRecording()
      recording = true
      buttonText.textContent = "STOP"
    }
  });

</script>
</body>
</html>
